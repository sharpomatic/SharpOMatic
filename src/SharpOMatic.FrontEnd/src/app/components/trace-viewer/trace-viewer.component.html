<div class="trace-viewer bg-body-tertiary flex-grow-1 p-1 h-100">
  <ng-template #renderNodes let-nodes="nodes" let-level="level">
    @for (node of nodes; track node.trace.traceId) {
    <div class="d-flex flex-row trace-line flex-grow-1" [style.paddingLeft.px]="level * 16">
      <span class="trace-toggle flex-shrink-0">
        @if (node.children.length > 0) {
        <button type="button"
                class="btn btn-link btn-sm p-0 me-1"
                (click)="toggleNode(node)"
                [attr.aria-expanded]="node.expanded">
          <i class="bi" [ngClass]="node.expanded ? 'bi-caret-down-fill' : 'bi-caret-right-fill'"></i>
        </button>
        } @else {
        <span class="trace-toggle-spacer me-1"></span>
        }
      </span>
      <span class="trace-thread flex-shrink-0">{{ node.trace.threadId }}</span>
      <i class="bi trace-symbol flex-shrink-0" [class]="getNodeSymbol(node.trace.nodeType)"></i>
      <div class="trace-title flex-shrink-0">{{ node.trace.title }}</div>
      <div class="d-flex flex-column trace-message flex-grow-1 align-items-start">
        <span class="trace-text" [class.running]="node.trace.nodeStatus === NodeStatus.Running"
          [class.success]="node.trace.nodeStatus === NodeStatus.Success"
          [class.failed]="node.trace.nodeStatus === NodeStatus.Failed">
          {{ node.trace.message }}
        </span>
        @if (node.trace.nodeStatus === NodeStatus.Failed) {
        <span>{{ node.trace.error }}</span>
        }
      </div>
    </div>
    @if (node.expanded && node.children.length > 0) {
      <ng-container *ngTemplateOutlet="renderNodes; context: { nodes: node.children, level: level + 1 }"></ng-container>
    }
    }
  </ng-template>

  <ng-container *ngTemplateOutlet="renderNodes; context: { nodes: traceTree, level: 0 }"></ng-container>
</div>
