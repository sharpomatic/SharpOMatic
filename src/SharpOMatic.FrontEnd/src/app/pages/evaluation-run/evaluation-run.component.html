<div class="d-flex flex-column bg-body-secondary h-100 evaluation-run-page">
  <div class="flex-shrink-0">
    <div class="d-flex align-items-center gap-2 p-3 pt-2 pb-0">
      <h2 class="">
        <i class="bi bi-clipboard-check pe-3 icon-sm"></i
        >{{ runDetail?.evalRun?.name || 'Run Detail' }}
      </h2>
    </div>
  </div>

  <div class="run-layout bg-body-tertiary">
    <div class="run-rows-master">
      <div class="run-rows-toolbar">
        <div class="input-group input-group-sm run-rows-search">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input
            type="search"
            class="form-control"
            placeholder="Search rows"
            [value]="runRowsSearchText"
            (input)="onRunRowsSearchChange($event)"
            (keyup.enter)="applyRunRowsSearch()"
          />
        </div>
      </div>

      <div class="run-rows-list list-group list-group-flush">
        @if (isLoadingRunRows) {
          <div class="text-muted p-2">Loading rows...</div>
        } @else if (!runRows.length) {
          <div class="text-muted fst-italic p-2">(no rows)</div>
        } @else {
          @for (row of runRows; track row.evalRunRowId) {
            <button
              type="button"
              class="list-group-item list-group-item-action run-row-item"
              [class.active]="isRunRowSelected(row)"
              [attr.aria-current]="isRunRowSelected(row) ? 'true' : null"
              (click)="selectRunRow(row)"
            >
              <div class="d-flex justify-content-between align-items-center">
                <span class="fw-semibold">{{ row.name || '(unnamed row)' }}</span>
                @if (shouldShowRunListStatus(row.status)) {
                  <span
                    class="run-text"
                    [class.running]="row.status === evalRunStatus.Running"
                    [class.failed]="row.status === evalRunStatus.Failed"
                    [class.canceled]="row.status === evalRunStatus.Canceled"
                  >
                    {{ getRunListStatusLabel(row.status) }}
                  </span>
                }
              </div>
            </button>
          }
        }
      </div>

      @if (runRowsPageCount() > 1) {
        <div class="run-rows-pagination px-2 py-2 border-top">
          <div class="d-flex justify-content-between align-items-center gap-2">
            <div class="small text-muted">
              Page {{ runRowsPage }} of {{ runRowsPageCount() }}
            </div>
            <nav aria-label="Run rows pagination">
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item" [class.disabled]="runRowsPage === 1">
                  <button
                    class="page-link"
                    type="button"
                    [disabled]="runRowsPage === 1"
                    (click)="onRunRowsPageChange(runRowsPage - 1)"
                  >
                    &lsaquo;
                  </button>
                </li>
                @for (page of runRowsPageNumbers(); track page) {
                  <li
                    class="page-item"
                    [class.active]="page === runRowsPage"
                    [attr.aria-current]="page === runRowsPage ? 'page' : null"
                  >
                    <button
                      class="page-link"
                      type="button"
                      (click)="onRunRowsPageChange(page)"
                    >
                      {{ page }}
                    </button>
                  </li>
                }
                <li
                  class="page-item"
                  [class.disabled]="runRowsPage >= runRowsPageCount()"
                >
                  <button
                    class="page-link"
                    type="button"
                    [disabled]="runRowsPage >= runRowsPageCount()"
                    (click)="onRunRowsPageChange(runRowsPage + 1)"
                  >
                    &rsaquo;
                  </button>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      }
    </div>

    <div class="run-row-detail">
      @if (selectedRunRow; as selectedRow) {
        <div class="p-3 run-row-detail-body">
          <div class="control-offset row-name-heading">
            {{ selectedRow.name || '(unnamed row)' }}
          </div>

          <div class="form-line">
            <label class="form-label field-label">Status</label>
            <div class="control-column short status-value">
              <span
                class="run-text"
                [class.running]="selectedRow.status === evalRunStatus.Running"
                [class.completed]="selectedRow.status === evalRunStatus.Completed"
                [class.failed]="selectedRow.status === evalRunStatus.Failed"
                [class.canceled]="selectedRow.status === evalRunStatus.Canceled"
              >
                {{ getRunStatusLabel(selectedRow.status) }}
              </span>
            </div>
          </div>

          @if (selectedRow.status === evalRunStatus.Failed) {
            <div class="form-line align-start">
              <label class="form-label field-label">Error</label>
              <div class="control-column long">
                <textarea class="form-control" rows="4" readonly>{{
                  selectedRow.error || '-'
                }}</textarea>
              </div>
            </div>
          }

          <div class="form-line">
            <label class="form-label field-label">Started</label>
            <div class="control-column half">
              <input
                type="text"
                class="form-control"
                [value]="formatDateTime(selectedRow.started)"
                readonly
              />
            </div>
          </div>

          <div class="form-line">
            <label class="form-label field-label">Finished</label>
            <div class="control-column half">
              <input
                type="text"
                class="form-control"
                [value]="formatDateTime(selectedRow.finished)"
                readonly
              />
            </div>
          </div>

          <div class="form-line align-start">
            <label class="form-label field-label">Output Context</label>
            <div class="control-column long">
              <app-context-viewer
                [contexts]="getOutputContexts(selectedRow)"
                mode="simple"
              ></app-context-viewer>
            </div>
          </div>

          <div class="control-offset graders-section-title">Graders</div>

          @if (!selectedRow.graders.length) {
            <div class="control-offset text-muted fst-italic">
              (no graders)
            </div>
          } @else {
            @for (grader of selectedRow.graders; track grader.evalRunRowGraderId) {
              <div class="form-line">
                <label class="form-label field-label">{{
                  grader.label || '(unnamed grader)'
                }}</label>
                <div class="control-column long grader-control">
                  <span
                    class="run-text"
                    [class.running]="grader.status === evalRunStatus.Running"
                    [class.completed]="grader.status === evalRunStatus.Completed"
                    [class.failed]="grader.status === evalRunStatus.Failed"
                    [class.canceled]="grader.status === evalRunStatus.Canceled"
                  >
                    {{ getRunStatusLabel(grader.status) }}
                  </span>
                  @if (grader.status !== evalRunStatus.Failed) {
                    <span class="grader-score">
                      Score:
                      <span class="grader-score-value">{{
                        formatScore(grader.score)
                      }}</span>
                    </span>
                  }
                </div>
              </div>

              @if (grader.status === evalRunStatus.Completed) {
                <div class="form-line align-start">
                  <label class="form-label field-label">Output Context</label>
                  <div class="control-column long">
                    <app-context-viewer
                      [contexts]="getGraderOutputContexts(grader)"
                      mode="simple"
                    ></app-context-viewer>
                  </div>
                </div>
              }

              @if (grader.status === evalRunStatus.Failed) {
                <div class="form-line align-start">
                  <label class="form-label field-label">&nbsp;</label>
                  <div class="control-column long">
                    <textarea class="form-control" rows="3" readonly>{{
                      grader.error || '-'
                    }}</textarea>
                  </div>
                </div>
              }
            }
          }
        </div>
      } @else {
        <div class="text-muted fst-italic p-3">
          Select a row to view details.
        </div>
      }
    </div>
  </div>
</div>
