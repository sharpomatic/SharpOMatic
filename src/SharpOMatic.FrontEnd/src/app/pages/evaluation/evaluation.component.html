<div class="d-flex flex-column bg-body-secondary h-100 evaluation-page">
  <div class="flex-shrink-0">
    <div
      class="d-flex justify-content-between align-items-center p-3 pt-2 pb-0"
    >
      <h2 class="">
        <i class="bi bi-clipboard-check pe-3 icon-sm"></i
        >{{ evalConfig.name() || "Evaluation" }}
      </h2>
      <div class="d-flex align-items-center gap-2">
        <button
          class="btn btn-primary"
          [disabled]="!canStartRun()"
          (click)="startRun()"
        >
          Start Run
        </button>
        <button
          class="btn btn-primary"
          [disabled]="
            !evalConfig.isDirty() ||
            hasColumnValidationErrors() ||
            hasRowValidationErrors()
          "
          (click)="save()"
        >
          Save
        </button>
      </div>
    </div>
  </div>

  <div class="tab-shell mt-1">
    <app-tab
      [tabs]="tabs"
      [(activeTabId)]="activeTabId"
      (activeTabChange)="onActiveTabChange($event)"
      [preventOverflow]="true"
    ></app-tab>
  </div>

  <ng-template #detailsTab>
    <div class="p-3 details bg-body-tertiary h-100">
      <div class="mb-3 form-line">
        <label for="eval-id" class="form-label field-label">Id</label>
        <div class="flex-fill control-column short">
          <input
            type="text"
            class="form-control w-100"
            id="eval-id"
            [ngModel]="evalConfig.evalConfigId"
            readonly
          />
        </div>
      </div>
      <div class="mb-3 form-line">
        <label for="eval-title" class="form-label field-label">Title</label>
        <div class="flex-fill control-column short">
          <input
            type="text"
            class="form-control w-100"
            id="eval-title"
            [ngModel]="evalConfig.name()"
            (ngModelChange)="evalConfig.name.set($event)"
          />
        </div>
      </div>
      <div class="mb-3 form-line">
        <label for="eval-description" class="form-label field-label"
          >Description</label
        >
        <div class="flex-fill control-column long">
          <input
            type="text"
            class="form-control w-100"
            id="eval-description"
            [ngModel]="evalConfig.description()"
            (ngModelChange)="evalConfig.description.set($event)"
          />
        </div>
      </div>
      <div class="mb-3 form-line">
        <label for="eval-workflow" class="form-label field-label"
          >Workflow</label
        >
        <div class="flex-fill control-column long">
          <select
            id="eval-workflow"
            class="form-select w-100"
            [ngModel]="workflowSelectionId"
            (ngModelChange)="onWorkflowChange($event)"
            [disabled]="!workflowSummaries.length"
          >
            <option [ngValue]="null">(None)</option>
            @for (workflow of workflowSummaries; track workflow.id) {
              <option [ngValue]="workflow.id">
                {{ workflow.name() }}
              </option>
            }
          </select>
        </div>
      </div>
      <div class="mb-3 form-line">
        <label for="eval-max-parallel" class="form-label field-label"
          >Max Parallel</label
        >
        <div class="flex-fill control-column tiny">
          <input
            id="eval-max-parallel"
            type="number"
            class="form-control w-100"
            min="1"
            step="1"
            inputmode="numeric"
            [ngModel]="evalConfig.maxParallel()"
            (ngModelChange)="onMaxParallelChange($event)"
          />
        </div>
      </div>
    </div>
  </ng-template>

  <ng-template #columnsTab>
    <div class="p-3 bg-body-tertiary h-100 columns-tab">
      <div class="mb-3">
        <div class="d-flex align-items-start gap-2 mb-2 columns-header">
          <label class="column-name">Name</label>
          <label class="column-type">Type</label>
          <label class="column-optional">Optional</label>
          <label class="column-input-path">Input Path</label>
        </div>
        @if (!evalConfig.columns().length) {
          <div class="text-muted fst-italic mb-2">(empty)</div>
        }
        @for (column of evalConfig.columns(); track column.evalColumnId) {
          <div class="d-flex align-items-start gap-2 mb-2 column-row">
            <input
              type="text"
              class="form-control column-name"
              [class.is-invalid]="isColumnNameInvalid(column)"
              [ngModel]="column.name()"
              (ngModelChange)="onColumnNameChange(column, $event)"
              [readonly]="isFixedColumn(column)"
              [title]="getColumnNameValidationMessage(column)"
            />
            <select
              class="form-select column-type"
              [ngModel]="column.entryType()"
              (ngModelChange)="onColumnTypeChange(column, $event)"
              [disabled]="isFixedColumn(column)"
            >
              @for (key of columnTypeKeys; track key) {
                <option [value]="getEnumValue(key)">
                  {{ getEnumDisplay(key) }}
                </option>
              }
            </select>
            <select
              class="form-select column-optional"
              [ngModel]="column.optional()"
              (ngModelChange)="onColumnOptionalChange(column, $event)"
              [disabled]="isFixedColumn(column)"
            >
              <option [ngValue]="false">Mandatory</option>
              <option [ngValue]="true">Optional</option>
            </select>
            <input
              type="text"
              class="form-control column-input-path"
              [ngModel]="column.inputPath()"
              (ngModelChange)="onColumnInputPathChange(column, $event)"
              [disabled]="isFixedColumn(column)"
            />
            <button
              class="btn btn-outline-primary"
              [disabled]="!canMoveColumnUp(column)"
              (click)="onMoveColumnUp(column)"
            >
              <i class="bi bi-arrow-up"></i>
            </button>
            <button
              class="btn btn-outline-primary"
              [disabled]="!canMoveColumnDown(column)"
              (click)="onMoveColumnDown(column)"
            >
              <i class="bi bi-arrow-down"></i>
            </button>
            <button
              class="btn btn-outline-danger"
              [disabled]="isFixedColumn(column)"
              (click)="onDeleteColumn(column)"
            >
              <i class="bi bi-trash"></i>
            </button>
          </div>
        }
        <button class="btn btn-primary mt-2" (click)="appendColumn()">
          Add
        </button>
      </div>
    </div>
  </ng-template>

  <ng-template #rowsTab>
    <div class="bg-body-tertiary h-100 rows-tab">
      <div class="rows-master">
        <div class="rows-master-toolbar">
          <button class="btn btn-primary btn-sm" (click)="appendRow()">
            Add
          </button>
          <button
            class="btn btn-outline-primary btn-sm"
            [disabled]="!canMoveSelectedRowUp()"
            (click)="onMoveSelectedRowUp()"
          >
            <i class="bi bi-arrow-up"></i>
          </button>
          <button
            class="btn btn-outline-primary btn-sm"
            [disabled]="!canMoveSelectedRowDown()"
            (click)="onMoveSelectedRowDown()"
          >
            <i class="bi bi-arrow-down"></i>
          </button>
          <button
            class="btn btn-outline-danger btn-sm"
            [disabled]="!selectedRow"
            (click)="onDeleteSelectedRow()"
          >
            <i class="bi bi-trash"></i>
          </button>
        </div>
        <div class="rows-master-list list-group list-group-flush">
          @if (!evalConfig.rows().length) {
            <div class="text-muted fst-italic p-2">(empty)</div>
          }
          @for (
            row of evalConfig.rows();
            track row.evalRowId;
            let index = $index
          ) {
            <button
              type="button"
              class="list-group-item list-group-item-action rows-master-item"
              [class.active]="isRowSelected(row)"
              [attr.aria-current]="isRowSelected(row) ? 'true' : null"
              (click)="selectRow(row)"
            >
              <span>{{ getRowListDisplayName(row, index) }}</span>
            </button>
          }
        </div>
      </div>
      <div class="rows-detail">
        @if (selectedRow; as row) {
          <div class="rows-detail-body p-3">
            @for (column of evalConfig.columns(); track column.evalColumnId) {
              <div class="mb-3 form-line">
                <label class="form-label field-label">{{
                  column.name()
                }}</label>
                <div
                  class="control-column"
                  [class.tiny]="
                    isBooleanColumn(column) ||
                    isIntColumn(column) ||
                    isDoubleColumn(column)
                  "
                  [class.long]="
                    !isBooleanColumn(column) &&
                    !isIntColumn(column) &&
                    !isDoubleColumn(column)
                  "
                >
                  @if (isJsonColumn(column)) {
                    <ngx-monaco-editor
                      class="row-editor row-editor-json"
                      [options]="getCellEditorOptions(column)"
                      [ngModel]="getStringCellValue(row, column)"
                      (ngModelChange)="onStringCellChange(row, column, $event)"
                    />
                  } @else if (isExpressionColumn(column)) {
                    <ngx-monaco-editor
                      class="row-editor row-editor-expression"
                      [options]="getCellEditorOptions(column)"
                      [ngModel]="getStringCellValue(row, column)"
                      (ngModelChange)="onStringCellChange(row, column, $event)"
                    />
                  } @else if (isBooleanColumn(column)) {
                    <select
                      class="form-select w-100"
                      [ngModel]="getBoolCellModelValue(row, column)"
                      (ngModelChange)="onBoolCellChange(row, column, $event)"
                    >
                      @if (column.optional()) {
                        <option value="">(none)</option>
                      }
                      <option value="true">True</option>
                      <option value="false">False</option>
                    </select>
                  } @else if (isIntColumn(column) || isDoubleColumn(column)) {
                    <input
                      type="number"
                      class="form-control w-100"
                      [attr.step]="isIntColumn(column) ? 1 : 'any'"
                      [ngModel]="getNumericCellValue(row, column)"
                      (ngModelChange)="onNumericCellChange(row, column, $event)"
                      (blur)="
                        onNumericCellBlur(
                          row,
                          column,
                          $any($event.target).value
                        )
                      "
                    />
                  } @else {
                    <input
                      type="text"
                      class="form-control w-100"
                      [class.is-invalid]="isRowNameFieldInvalid(row, column)"
                      [ngModel]="getStringCellValue(row, column)"
                      (ngModelChange)="onStringCellChange(row, column, $event)"
                      (blur)="
                        onStringCellBlur(row, column, $any($event.target).value)
                      "
                    />
                  }
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="rows-detail-empty text-muted fst-italic">
            Add a row to begin editing values.
          </div>
        }
      </div>
    </div>
  </ng-template>

  <ng-template #gradersTab>
    <div class="p-3 bg-body-tertiary h-100 graders-tab">
      <div class="mb-3">
        <div class="d-flex align-items-start gap-2 mb-2 graders-header">
          <label class="grader-name">Name</label>
          <label class="grader-workflow">Workflow</label>
          <label class="grader-threshold">Pass Threshold</label>
        </div>
        @if (!evalConfig.graders().length) {
          <div class="text-muted fst-italic mb-2">(empty)</div>
        }
        @for (grader of evalConfig.graders(); track grader.evalGraderId) {
          <div class="d-flex align-items-start gap-2 mb-2 grader-row">
            <input
              type="text"
              class="form-control grader-name"
              [ngModel]="grader.label()"
              (ngModelChange)="grader.label.set($event)"
            />
            <select
              class="form-select grader-workflow"
              [ngModel]="graderWorkflowSelectionId(grader)"
              (ngModelChange)="onGraderWorkflowChange(grader, $event)"
              [disabled]="!workflowSummaries.length"
            >
              <option [ngValue]="null">(None)</option>
              @for (workflow of workflowSummaries; track workflow.id) {
                <option [ngValue]="workflow.id">
                  {{ workflow.name() }}
                </option>
              }
            </select>
            <input
              type="number"
              class="form-control grader-threshold"
              inputmode="decimal"
              step="any"
              [ngModel]="grader.passThreshold()"
              (ngModelChange)="onPassThresholdChange(grader, $event)"
            />
            <button
              class="btn btn-outline-primary"
              [disabled]="!canMoveGraderUp(grader)"
              (click)="onMoveGraderUp(grader)"
            >
              <i class="bi bi-arrow-up"></i>
            </button>
            <button
              class="btn btn-outline-primary"
              [disabled]="!canMoveGraderDown(grader)"
              (click)="onMoveGraderDown(grader)"
            >
              <i class="bi bi-arrow-down"></i>
            </button>
            <button
              class="btn btn-outline-danger"
              (click)="onDeleteGrader(grader)"
            >
              <i class="bi bi-trash"></i>
            </button>
          </div>
        }
        <button class="btn btn-primary mt-2" (click)="appendGrader()">
          Add
        </button>
      </div>
    </div>
  </ng-template>

  <ng-template #runsTab>
    <div class="bg-body-tertiary h-100 runs-tab">
      <div class="runs-master">
        <div class="runs-master-toolbar">
          <div class="input-group input-group-sm runs-search">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input
              type="search"
              class="form-control"
              placeholder="Search runs"
              [value]="runsSearchText"
              (input)="onRunsSearchChange($event)"
              (keyup.enter)="applyRunsSearch()"
            />
          </div>
          <button
            class="btn btn-outline-warning btn-sm"
            type="button"
            [disabled]="!canCancelSelectedRun()"
            title="Cancel selected running run"
            (click)="cancelSelectedRun()"
          >
            <i class="bi bi-x-circle"></i>
          </button>
          <button
            class="btn btn-outline-danger btn-sm"
            type="button"
            [disabled]="!canDeleteSelectedRun()"
            [title]="
              selectedRunDetail?.evalRun?.status === evalRunStatus.Running
                ? 'Running runs cannot be deleted.'
                : 'Delete selected run'
            "
            (click)="deleteSelectedRun()"
          >
            <i class="bi bi-trash"></i>
          </button>
        </div>

        <div class="runs-master-list list-group list-group-flush">
          @if (isLoadingRuns) {
            <div class="text-muted p-2">Loading runs...</div>
          } @else if (!runs.length) {
            <div class="text-muted fst-italic p-2">(no runs)</div>
          } @else {
            @for (run of runs; track run.evalRunId) {
              <button
                type="button"
                class="list-group-item list-group-item-action runs-master-item"
                [class.active]="isRunSelected(run)"
                [attr.aria-current]="isRunSelected(run) ? 'true' : null"
                (click)="selectRun(run)"
                (dblclick)="openRunDetail(run)"
              >
                <div class="d-flex justify-content-between align-items-center">
                  <span class="fw-semibold">{{ run.name || '(unnamed run)' }}</span>
                  @if (shouldShowRunListStatus(run.status)) {
                    <span
                      class="run-text"
                      [class.running]="run.status === evalRunStatus.Running"
                      [class.failed]="run.status === evalRunStatus.Failed"
                      [class.canceled]="run.status === evalRunStatus.Canceled"
                    >
                      {{ getRunListStatusLabel(run.status) }}
                    </span>
                  }
                </div>
                @if (isRunListProgressVisible(run)) {
                  <div class="run-progress-row">
                    <div
                      class="progress run-progress-bar"
                      role="progressbar"
                      [attr.aria-valuenow]="getRunProgressPercent(run)"
                      aria-valuemin="0"
                      aria-valuemax="100"
                    >
                      <div
                        class="progress-bar"
                        [style.width.%]="getRunProgressPercent(run)"
                      ></div>
                    </div>
                    <span class="run-progress-label text-body-secondary">
                      {{ getRunProgressLabel(run) }}
                    </span>
                  </div>
                }
              </button>
            }
          }
        </div>

        @if (runsPageCount() > 1) {
          <div class="runs-pagination px-2 py-2 border-top">
            <div class="d-flex justify-content-between align-items-center gap-2">
              <div class="small text-muted">
                Page {{ runsPage }} of {{ runsPageCount() }}
              </div>
              <nav aria-label="Run pagination">
                <ul class="pagination pagination-sm mb-0">
                  <li class="page-item" [class.disabled]="runsPage === 1">
                    <button
                      class="page-link"
                      type="button"
                      [disabled]="runsPage === 1"
                      (click)="onRunsPageChange(runsPage - 1)"
                    >
                      &lsaquo;
                    </button>
                  </li>
                  @for (page of runsPageNumbers(); track page) {
                    <li
                      class="page-item"
                      [class.active]="page === runsPage"
                      [attr.aria-current]="page === runsPage ? 'page' : null"
                    >
                      <button
                        class="page-link"
                        type="button"
                        (click)="onRunsPageChange(page)"
                      >
                        {{ page }}
                      </button>
                    </li>
                  }
                  <li
                    class="page-item"
                    [class.disabled]="runsPage >= runsPageCount()"
                  >
                    <button
                      class="page-link"
                      type="button"
                      [disabled]="runsPage >= runsPageCount()"
                      (click)="onRunsPageChange(runsPage + 1)"
                    >
                      &rsaquo;
                    </button>
                  </li>
                </ul>
              </nav>
            </div>
          </div>
        }
      </div>

      <div class="runs-detail">
        @if (selectedRunDetail) {
          <div class="runs-detail-body p-3">
            @if (!sortedGraderSummaries.length) {
              <div class="text-muted">(no grader summaries)</div>
            } @else {
              <div class="d-flex flex-column gap-3">
                @for (summary of sortedGraderSummaries; track summary.evalRunGraderSummaryId) {
                  <app-eval-grader-result
                    [summary]="summary"
                  ></app-eval-grader-result>
                }
              </div>
            }
          </div>
        } @else {
          <div class="runs-detail-empty text-muted fst-italic p-3">
            Select a run to view details.
          </div>
        }
      </div>
    </div>
  </ng-template>
</div>
