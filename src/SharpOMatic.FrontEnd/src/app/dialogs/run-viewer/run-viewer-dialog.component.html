<div class="d-flex flex-column dialog-overlay bg-body-secondary">
  <div class="d-flex flex-column dialog-content">
    <div class="d-flex justify-content-between align-items-center p-3 pt-2 pb-1">
      <div class="d-flex align-items-center gap-3">
        <h2 class="mb-0"><i class="bi bi-activity pe-3 icon-sm"></i>Run Viewer</h2>
      </div>
      <button class="btn btn-primary" (click)="onClose()">Close</button>
    </div>

    <div class="tab-shell">
      <app-tab [tabs]="tabs" [(activeTabId)]="activeTabId"></app-tab>
    </div>

    <ng-template #runTab>
      <div class="bg-body-tertiary p-3 run-details">
        @for (property of runProperties; track property.label) {
        <div class="mb-3 form-line">
          <label class="form-label field-label" [class.align-top]="property.multiline">{{ property.label }}</label>
          <div class="control-column">
            @if (property.status) {
            <span class="run-text" [class.created]="run.runStatus === RunStatus.Created"
              [class.running]="run.runStatus === RunStatus.Running"
              [class.success]="run.runStatus === RunStatus.Success"
              [class.failed]="run.runStatus === RunStatus.Failed">
              {{ property.value }}
            </span>
            } @else if (property.multiline) {
            <textarea class="form-control run-textarea" rows="8" [value]="property.value" readonly></textarea>
            } @else if (property.date) {
            <input type="text" class="form-control run-input" [value]="property.value ? (property.value | date:'short') : ''" readonly />
            } @else {
            <input type="text" class="form-control run-input" [value]="property.value" readonly />
            }
          </div>
        </div>
        }
      </div>
    </ng-template>

    <ng-template #inputTab>
      <div class="bg-body-tertiary flex-grow-1 d-flex flex-column p-3 h-100">
        @if (runInputs.entries().length > 0) {
        <div class="run-inputs flex-grow-1">
          <div class="d-flex align-items-start gap-2 mb-2">
            <label class="form-label editPath mb-0">Path</label>
            <label class="form-label editType mb-0">Type</label>
            <label class="form-label editValue mb-0">Value</label>
          </div>
          @for (entry of runInputs.entries(); track entry.id) {
          <div class="d-flex align-items-start gap-2 mb-2 run-input-row">
            <input type="text" class="form-control editPath" [value]="entry.inputPath()" readonly />
            <input type="text" class="form-control editType" [value]="getEntryTypeDisplay(entry.entryType())" readonly />
            @if (entry.entryType() === contextEntryType.JSON) {
            <div class="editValue">
              <ngx-monaco-editor class="editJson" [options]="getEditorOptions(entry)" [ngModel]="entry.entryValue()" />
            </div>
            } @else if (entry.entryType() === contextEntryType.Expression) {
            <div class="editValue">
              <ngx-monaco-editor class="editExpression" [options]="getEditorOptions(entry)" [ngModel]="entry.entryValue()" />
            </div>
            } @else if (entry.entryType() === contextEntryType.Bool) {
            <div class="d-flex editValue">
              <select class="form-select editBoolValue" [ngModel]="entry.entryValue() || 'False'" disabled>
                <option value="True">True</option>
                <option value="False">False</option>
              </select>
            </div>
            } @else if (entry.entryType() === contextEntryType.Int) {
            <input type="number" class="form-control editValue" inputmode="numeric" pattern="[0-9]*" step="1"
              [ngModel]="entry.entryValue() !== '' ? +entry.entryValue() : null" readonly />
            } @else if (entry.entryType() === contextEntryType.Double) {
            <input type="number" class="form-control editValue" inputmode="decimal" step="any"
              [ngModel]="entry.entryValue() !== '' ? +entry.entryValue() : null" readonly />
            } @else if (entry.entryType() === contextEntryType.AssetRef || entry.entryType() === contextEntryType.AssetRefList) {
            <input type="text" class="form-control editValue" [value]="getAssetEntryDisplay(entry)" [title]="getAssetEntryDisplay(entry)" readonly />
            } @else {
            <input type="text" class="form-control editValue" [ngModel]="entry.entryValue()" readonly />
            }
          </div>
          }
        </div>
        }
      </div>
    </ng-template>

    <ng-template #outputTab>
      <div class="bg-body-tertiary flex-grow-1 d-flex flex-column p-3 h-100">
        <app-context-viewer [contexts]="outputContexts" mode="simple"></app-context-viewer>
      </div>
    </ng-template>

    <ng-template #assetsTab>
      <div class="bg-body-tertiary flex-grow-1 d-flex flex-column p-3 h-100 run-assets">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <div class="fw-semibold">Assets ({{ runAssets.length }})</div>
        </div>
        @if (runAssets.length === 0) {
          <div class="empty-state text-body-secondary">
            <div class="empty-icon"><i class="bi bi-images"></i></div>
            <div class="empty-title">No run assets</div>
            <div class="empty-subtitle">This run did not generate any assets.</div>
          </div>
        } @else {
          <div class="table-responsive run-assets-table">
            <table class="table table-sm table-striped table-hover align-middle">
              <thead>
                <tr>
                  <th scope="col" class="col-id">Id</th>
                  <th scope="col" class="col-name">Name</th>
                  <th scope="col" class="col-type">Type</th>
                  <th scope="col" class="col-size">Size</th>
                  <th scope="col" class="col-created">Created</th>
                  <th scope="col" class="col-actions text-end"></th>
                </tr>
              </thead>
              <tbody>
                @for (asset of runAssets; track asset.assetId) {
                  <tr>
                    <td class="col-id text-truncate" title="{{ asset.assetId }}">{{ asset.assetId }}</td>
                    <td class="col-name text-truncate" title="{{ asset.name }}">{{ asset.name }}</td>
                    <td class="col-type text-truncate" title="{{ asset.mediaType }}">{{ asset.mediaType }}</td>
                    <td class="col-size">{{ formatSize(asset.sizeBytes) }}</td>
                    <td class="col-created">{{ asset.created | date:'short' }}</td>
                    <td class="col-actions text-end">
                      <div class="d-inline-flex gap-2">
                        @if (isImageAsset(asset)) {
                          <button class="btn btn-sm btn-outline-primary" (click)="openAssetPreview(asset)">View</button>
                        }
                        @if (isViewableTextAsset(asset)) {
                          <button class="btn btn-sm btn-outline-primary" (click)="openAssetViewer(asset)">View</button>
                        }
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>
    </ng-template>

    <ng-template #traceTab>
      <app-trace-viewer [traces]="traces"></app-trace-viewer>
    </ng-template>
  </div>
</div>
