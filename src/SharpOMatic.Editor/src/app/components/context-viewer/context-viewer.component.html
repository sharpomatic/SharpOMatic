<div>
  <div class="form-line">
    <label for="select-context" class="form-label field-label">Select Context</label>
    <div class="flex-fill control-column context">
      <select class="form-select selectContext"
              id="select-context"
              [disabled]="contexts.length === 0"
              [ngModel]="selectedIndex()"
              (ngModelChange)="onSelectedIndexChange($event)">
        @for (context of contexts; track $index; let i = $index) {
          <option [ngValue]="i">
            Call {{ i + 1 }}
          </option>
        }
        @if (contexts.length === 0) {
          <option [ngValue]="-1">(none)</option>
        }
      </select>
    </div>
  </div>

  <hr/>

  <label for="select-context" class="form-label">Context Contents</label>  

  @if (errorMessage()) {
    <div class="text-muted fst-italic">{{ errorMessage() }}</div>
  } @else {
    @if (contextTree().length === 0) {
      <div class="text-muted fst-italic">(empty)</div>
    } @else {
      <div class="context-tree">
        <ng-template #renderNodes let-nodes="nodes" let-level="level">
          @for (node of nodes; track node.name) {
            <div class="tree-row" [style.paddingLeft.px]="level * 16">
              <span class="toggle">
                @if (node.children.length > 0) {
                  <button type="button"
                          class="btn btn-link btn-sm p-0 me-2"
                          (click)="toggleNode(node)"
                          [attr.aria-expanded]="node.expanded">
                    <i class="bi" [ngClass]="node.expanded ? 'bi-caret-down-fill' : 'bi-caret-right-fill'"></i>
                  </button>
                } @else {
                  <span class="toggle-spacer me-2"></span>
                }
              </span>
              <span class="type text-muted">{{ node.type }}</span>
              <span class="name">{{ node.name }}</span>
              <code class="value context-value">{{ node.displayValue }}</code>
            </div>
            @if (node.expanded && node.children.length > 0) {
              <ng-container *ngTemplateOutlet="renderNodes; context: { nodes: node.children, level: level + 1 }"></ng-container>
            }
          }
        </ng-template>

        <ng-container *ngTemplateOutlet="renderNodes; context: { nodes: contextTree(), level: 0 }"></ng-container>
      </div>
    }
  }
</div>
